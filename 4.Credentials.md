# 4. Credentials

To receive and store a credential locally, two processes must be completed:

1. [Accept the credential offer](#accept-credential-offer)
2. [Receive and generate the credential](#receive-and-generate-credential)

--- 

### Credentials Flow
*![](wiki-images/AcceptingCredentialOffer.png)* <!--This illustration makes sense because it shows a process. However, the diamond doesn't show the decisions branching off.-->

--- 
## Accept the credential offer

After receiving a push notification with the credential offer object, the process  follows these next steps to accept the credential offer:

### 1. Deserialize the connection

<!--Where is this code visible? Are we just showing which blocks of code perform each function?-->

<!--Do the customers already know what it means to deserialize the connection and why it's done?-->

<!--In this whole document I need sherpa notes to tell me what the variables are and why each step is necessary, or at least give more info.-->

##### iOS

```ObjC
[[sdkAPI] connectionDeserialize: serializedConnection completion:^(NSError *error, NSInteger connectionHandle) {
// handle errors first
}
```


#### Android

```java
ConnectionApi.connectionDeserialize(serializedConnection)
    .exceptionally((t) -> {
        // hadle error response
        return -1;
    }).thenAccept(result -> {
        if (result != -1) {
            // handle successful result
        }
    });
```


### 2. Create the credential with a `messageID`

#### iOS 

```ObjC 
[[sdkAPI] credentialCreateWithMsgid: messageId 
    connectionHandle: (int)connectionHandle 
    msgId: messageId 
    completion: ^(NSError *error, NSInteger credentialHandle, NSString* credentialOffer) {
    // handle errors first
    //... proceed with next step
}
```

#### Android

```java
CredentialApi.credentialCreateWithMsgid(sourceId, connectionHandle, messageId)
    .exceptionally((t) -> {
        // hadle error response
        return null;
    }).thenAccept(result -> {
        GetCredentialCreateMsgidResult typedResult = (GetCredentialCreateMsgidResult) result;
        WritableMap vcxCredentialCreateResult = Arguments.createMap();
        vcxCredentialCreateResult.putInt("credential_handle", typedResult.getCredential_handle());
        vcxCredentialCreateResult.putString("credential_offer", typedResult.getOffer());
        // handle successful result
    });
```


### 3. Serialize the credential

#### iOS 
```ObjC
[[sdkAPI] credentialSerialize:credentialHandle 
    completion:^(NSError *error, NSString *claimOffer) {
// handle errors first
//... proceed with next step
}
```


#### Android

```java
CredentialApi.credentialSerialize(credentialHandle)
    .exceptionally((t) -> {
        // hadle error response
        return null;
    }).thenAccept(result -> {
        // handle successful result
    });
```

### 4. Get the state for the credential 

#### iOS 
```ObjC
[[sdkAPI] credentialGetState:credentialHandle 
    completion:^(NSError *error, NSInteger state) {
// handle errors first
//... proceed with next step
}
```


#### Android

```java
CredentialApi.credentialGetState(credentialHandle)
    .exceptionally((t) -> {
        // hadle error response
        return -1;
    }).thenAccept(result -> {
        if (result != -1) {
        // handle successful result
        }
    });
```

### 5. Deserialize the credential

#### iOS 
```ObjC
[[sdkAPI] credentialDeserialize: serializedCredential_cString 
    completion: ^(NSError *error, NSInteger credentialHandle) {
// handle errors first
//... proceed with next step
}
```


#### Android

```java
CredentialApi.credentialDeserialize(serializedCredential)
    .exceptionally((t) -> {
        // hadle error response
        return -1;
    }).thenAccept(result -> {
        if (result != -1) {
            // handle successful result
        }
    });
```

### 6. Send the credential request 

#### iOS 
```ObjC
[[sdkAPI] credentialSendRequest: credentialHandle connectionHandle: (int)connectionHandle paymentHandle: 0 completion: ^(NSError *error) {
// handle errors first
//... proceed with next step
}
```

#### Android

```java
CredentialApi.credentialSendRequest(credentialHandle, connectionHandle, paymentHandle)
    .exceptionally((t) -> {
        // hadle error response
        return null;
    }).thenAccept(result -> {
        // handle successful result
    });

```

## Receive and generate the credential

<!--Again, I need sherpa notes for each block of code: variables, why they do what they do.-->

### 1. Serialize the credential

#### iOS 
```ObjC
[[sdkAPI]  credentialSerialize:credentialHandle completion:^(NSError *error, NSString *claimOffer) {
// handle errors first
//... proceed with next step
}
```

#### Android

```java
 CredentialApi.credentialSerialize(credentialHandle)
    .exceptionally((t) -> { 
        // hadle error response
        return null;
    }).thenAccept(result -> {
        // handle successful result
    });

```

### 2. Get the state for the credential

#### iOS 
```ObjC
[[sdkAPI]  credentialGetState:credentialHandle completion:^(NSError *error, NSInteger state) {
// handle errors first
//... proceed with next step
}
```


#### Android

```java
CredentialApi.credentialGetState(credentialHandle)
    .exceptionally((t) -> {
        // hadle error response
        return -1;
    }).thenAccept(result -> {
        if (result != -1) {
            // handle successful result
        }
    });
```

### 3. Update the credential state

#### iOS 
```ObjC
[[sdkAPI] credentialUpdateState: credentialHandle completion: ^(NSError *error, NSInteger state) {
// handle errors first
//... proceed with next step
}
```

#### Android

```java
CredentialApi.credentialUpdateState(credentialHandle)
    .exceptionally((t) -> {
        // handle error response
            return -1;
    })
    .thenAccept(result -> {
        if (result != -1) {
            // handle success message
        }
    });
```

### 4. Get the credential 

#### iOS 
```ObjC
[[sdkAPI] getCredential: credentialHandle completion: ^(NSError *error, NSString *credential) {
// handle errors first
...
}
```


#### Android

```java
CredentialApi.getCredential(credentialHandle)
    .exceptionally((t) -> {
        // handle error response
        return null;
    }).thenAccept(result -> {
        // handle success message
    });
```

When the process has finished, you can store the credential locally on the user device. <!--Do they know how to do this?-->
