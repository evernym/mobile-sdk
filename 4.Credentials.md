# 4. Credentials

To receive and store a credential locally, two processes must be completed:

1. [Accept the credential offer](#Accept-the-credential-offer)

    1. Receive the push notification from the Issuer.
    2. Deserialize the connection.
    3. Create the credential with a message ID.
    4. Serialize the credential.
    5. Get the state for the credential.
    6. Deserialize the credential.
    7. Send the credential request.

2. [Receive and generate the credential](#Receive-and-generate-the-credential)
    1. Receive the credential.
    2. Serialize the credential.
    3. Get the state for the credential.
    4. Update the credential state.
    5. Get the credential.
    6. Store the credential locally.

3. [Get credential offers from pending messages](#get-offers)
    1. Retrieve pending messages
    2. Parse pending message
    3. Deserialize connection
    4. Create credential with offer
    5. Serialize credential

4. [Accept credential offer](#accept-offer)
    1. Deserialize connection
    2. Deserialize credential
    3. Send credential request
    4. Get connectionon pwDid
    5. Update message status
    6. Serialize credential

<!--### Credentials Flow
*![](wiki-images/AcceptingCredentialOffer.png)* This illustration makes sense because it shows a process. However, the Received Credential [Offer] diamond doesn't show decisions branching off it. Bonnie will create a new version.-->

--- 
## Accept the credential offer

After receiving a push notification with the credential-offer object, the process follows these next steps to accept the credential offer.

### 1. Deserialize the connection

<!--[Q1] Please provide a short explanation of how/why the system deserialize the connection. One or two sentences. Please be sure to specify which component of the system is performing the action, e.g., "The mobile app sends..." or "The user enters..."-->

##### iOS

<!--[Q2] Where is this code visible?-->

```ObjC
[[sdkAPI] connectionDeserialize: serializedConnection completion:^(NSError *error, NSInteger connectionHandle) {
// handle errors first
}
```


#### Android

<!--[Q3] Where is this code visible?-->

```java
ConnectionApi.connectionDeserialize(serializedConnection)
    .exceptionally((t) -> {
        // handle error response
        return -1;
    }).thenAccept(result -> {
        if (result != -1) {
            // handle successful result
        }
    });
```


### 2. Create the credential with a `messageID`

<!--[Q4] Please provide a short explanation of how/why the system creates a credential with a messageID.-->

#### iOS 

<!--[Q5] Where is this code visible?-->

```ObjC 
[[sdkAPI] credentialCreateWithMsgid: messageId 
    connectionHandle: (int)connectionHandle 
    msgId: messageId 
    completion: ^(NSError *error, NSInteger credentialHandle, NSString* credentialOffer) {
    // handle errors first
    //... proceed with next step
}
```

#### Android

<!--[Q6] Where is this code visible?-->

```java
CredentialApi.credentialCreateWithMsgid(sourceId, connectionHandle, messageId)
    .exceptionally((t) -> {
        // handle error response
        return null;
    }).thenAccept(result -> {
        GetCredentialCreateMsgidResult typedResult = (GetCredentialCreateMsgidResult) result;
        WritableMap vcxCredentialCreateResult = Arguments.createMap();
        vcxCredentialCreateResult.putInt("credential_handle", typedResult.getCredential_handle());
        vcxCredentialCreateResult.putString("credential_offer", typedResult.getOffer());
        // handle successful result
    });
```


### 3. Serialize the credential

<!--[Q7] Please provide a short explanation of how/why the system serializes the credential-->

#### iOS 

<!--[Q8] Where is this code visible?-->

```ObjC
[[sdkAPI] credentialSerialize:credentialHandle 
    completion:^(NSError *error, NSString *claimOffer) {
// handle errors first
//... proceed with next step
}
```


#### Android

<!--[Q9] Where is this code visible?-->

```java
CredentialApi.credentialSerialize(credentialHandle)
    .exceptionally((t) -> {
        // handle error response
        return null;
    }).thenAccept(result -> {
        // handle successful result
    });
```

### 4. Get the state for the credential 

<!--[Q10] Please provide a short explanation of how/why the system gets the state for the credential.-->

#### iOS 
<!--[Q11] Where is this code visible?-->

```ObjC
[[sdkAPI] credentialGetState:credentialHandle 
    completion:^(NSError *error, NSInteger state) {
// handle errors first
//... proceed with next step
}
```


#### Android

<!--[Q12] Where is this code visible?-->

```java
CredentialApi.credentialGetState(credentialHandle)
    .exceptionally((t) -> {
        // handle error response
        return -1;
    }).thenAccept(result -> {
        if (result != -1) {
        // handle successful result
        }
    });
```

### 5. Deserialize the credential

<!--[Q13] Please provide a short explanation of how/why the system deserializes the credential-->

#### iOS 

<!--[Q14] Where is this code visible?-->

```ObjC
[[sdkAPI] credentialDeserialize: serializedCredential_cString 
    completion: ^(NSError *error, NSInteger credentialHandle) {
// handle errors first
//... proceed with next step
}
```


#### Android

<!--[Q15] Where is this code visible?-->

```java
CredentialApi.credentialDeserialize(serializedCredential)
    .exceptionally((t) -> {
        // handle error response
        return -1;
    }).thenAccept(result -> {
        if (result != -1) {
            // handle successful result
        }
    });
```

### 6. Send the credential request 

<!--[Q16] Please provide a short explanation of how/why the system sends the credential request-->

#### iOS 

<!--[Q17] Where is this code visible?-->

```ObjC
[[sdkAPI] credentialSendRequest: credentialHandle connectionHandle: (int)connectionHandle paymentHandle: 0 completion: ^(NSError *error) {
// handle errors first
//... proceed with next step
}
```

#### Android

<!--[Q18] Where is this code visible?-->

```java
CredentialApi.credentialSendRequest(credentialHandle, connectionHandle, paymentHandle)
    .exceptionally((t) -> {
        // handle error response
        return null;
    }).thenAccept(result -> {
        // handle successful result
    });

```
---
## Receive and generate the credential


### 1. Serialize the credential

<!--[Q19] Please provide a short explanation of how/why the system serializes the credential-->

#### iOS 

<!--[Q20] Where is this code visible?-->

```ObjC
[[sdkAPI]  credentialSerialize:credentialHandle completion:^(NSError *error, NSString *claimOffer) {
// handle errors first
//... proceed with next step
}
```

#### Android

<!--[Q21] Where is this code visible?-->

```java
 CredentialApi.credentialSerialize(credentialHandle)
    .exceptionally((t) -> { 
        // handle error response
        return null;
    }).thenAccept(result -> {
        // handle successful result
    });

```

### 2. Get the state for the credential

<!--[Q22] Please provide a short explanation of how/why the system gets the state for the credential-->

#### iOS 

<!--[Q23] Where is this code visible?-->

```ObjC
[[sdkAPI]  credentialGetState:credentialHandle completion:^(NSError *error, NSInteger state) {
// handle errors first
//... proceed with next step
}
```


#### Android

<!--[Q24] Where is this code visible?-->

```java
CredentialApi.credentialGetState(credentialHandle)
    .exceptionally((t) -> {
        // handle error response
        return -1;
    }).thenAccept(result -> {
        if (result != -1) {
            // handle successful result
        }
    });
```

### 3. Update the credential state

<!--[Q25] Please provide a short explanation of how/why the system updates the credential state-->

#### iOS 

<!--[Q26] Where is this code visible?-->

```ObjC
[[sdkAPI] credentialUpdateState: credentialHandle completion: ^(NSError *error, NSInteger state) {
// handle errors first
//... proceed with next step
}
```

#### Android

<!--[Q27] Where is this code visible?-->

```java
CredentialApi.credentialUpdateState(credentialHandle)
    .exceptionally((t) -> {
        // handle error response
            return -1;
    })
    .thenAccept(result -> {
        if (result != -1) {
            // handle success message
        }
    });
```

### 4. Get the credential 

<!--[Q28] Please provide a short explanation of how/why the system gets the credential-->

#### iOS 
<!--[Q29] Where is this code visible?-->

```ObjC
[[sdkAPI] getCredential: credentialHandle completion: ^(NSError *error, NSString *credential) {
// handle errors first
...
}
```

#### Android

<!--[Q30] Where is this code visible?-->

```java
CredentialApi.getCredential(credentialHandle)
    .exceptionally((t) -> {
        // handle error response
        return null;
    }).thenAccept(result -> {
        // handle success message
    });
```

When the process has finished, you can store the credential locally on the user device. <!--[Q31] How is this done?-->

<a id="get-offers"></a>

## 3. Get credential offers from pending messages

### 1. Retrieve pending messages
See [messages documentation](8.%20Messages.md) for message retrieval information. Pending messages with credential offer type should be retrieved.

### 2. Parse pending message

Extract credential offer JSON string from message.
Following fields could be used for user interaction:

* `claim_name` - Name of the claim
* `credential_attrs` - JSON object containing pairs of offered credential name and value

For example, see `CredentialOffersViewModel#extractDataFromCredentialsOfferMessage()`

### 3. Deserialize connection

Retrieve connection handle using stored serialzied connection.

#### Android
```java
int connectionHandle = ConnectionApi.connectionDeserialize(serializedConnection).get();
```

### 4. Create credential with offer 

#### Android
```java
int credentialHandle = CredentialApi.credentialCreateWithOffer(sourceId, message).get();
```

`sourceId` - any string\
`message` - message retrieved on step 1.

### 5. Serialize credential


#### Android
```java
String serializedCredential = CredentialApi.credentialSerialize(creentialdHandle);
```

You should store serialized credential for latter operations.

<a id="accept-offer"></a>

## 3. Accept credential offer

In case user is agreed to receive provided credentials from this connections, following steps should be performed.

### 1. Deserialize connection

#### Android
```java
int connectionHandle = ConnectionApi.connectionDeserialize(serializedConnection).get();
```

### 2. Deserialize credential

#### Android
```java
int credOfferHandle = CredentialApi.credentialDeserialize(serializedCredOffer).get();
```

### 3. Send credential request

#### Android
```java
CredentialApi.credentialSendRequest(credOfferHandle, connectionHandle, 0).get()
```

### 4. Get connectionon pwDid

#### Android
```java
String pwDid = ConnectionApi.connectionGetPwDid(connectionHandle).get()
```

### 5. Update message status

See [messages documentation](8.%20Messages.md) for message update information.


### 6. Serialize credential

#### Android
```java
String serializedCredential = CredentialApi.credentialSerialize(creentialdHandle).get();
```

Serialized credential should be stored for latter usage.

### 7. Await credential status change

#### Android

Await credential status change. Call following code in loop until returned state is not equal `4` (`Accepted`):

```java
CredentialApi.credentialSerialize(creentialdHandle).get();
int status = CredentialApi.credentialGetState(handle).get();
```


### Credential offer message sample

```json
{
    "statusCode": "MS-103",
    "payload": null,
    "senderDID": "Byyf6DiChBaukbgPssuFi1",
    "uid": "b060ca52-873e-4606-bf49-8ba83e4320a0",
    "type": "credOffer",
    "refMsgId": null,
    "deliveryDetails": [],
    "decryptedPayload": "{\"@type\":{\"name\":\"CRED_OFFER\",\"ver\":\"1.0\",\"fmt\":\"json\"},\"@msg\":\"[{\\\"claim_id\\\":\\\"123\\\",\\\"claim_name\\\":\\\"DEMO-Transcript\\\",\\\"cred_def_id\\\":\\\"R9kuPrDFDVKNRL1oFpRxg2:3:CL:33627:tag1\\\",\\\"credential_attrs\\\":{\\\"DEMO-College Name\\\":\\\"Faber College\\\",\\\"DEMO-Degree\\\":\\\"Computer Science\\\",\\\"DEMO-GPA\\\":\\\"4.0\\\",\\\"DEMO-Major\\\":\\\"SSI Software Engineering\\\",\\\"DEMO-Student Name\\\":\\\"Alice Andersen\\\"},\\\"from_did\\\":\\\"Byyf6DiChBaukbgPssuFi1\\\",\\\"libindy_offer\\\":\\\"{\\\\\\\"schema_id\\\\\\\":\\\\\\\"R9kuPrDFDVKNRL1oFpRxg2:2:DEMO-Transcript:1.0\\\\\\\",\\\\\\\"cred_def_id\\\\\\\":\\\\\\\"R9kuPrDFDVKNRL1oFpRxg2:3:CL:33627:tag1\\\\\\\",\\\\\\\"key_correctness_proof\\\\\\\":{\\\\\\\"c\\\\\\\":\\\\\\\"18409263165024561057868297548338734429203182181892601294150224288240356148969\\\\\\\",\\\\\\\"xz_cap\\\\\\\":\\\\\\\"89092862071754482768568121750605441740780661720589296980571662371912825324849589562417824532135192968565372473462126811235969943884283863879335732191646688609906727685365837864115018709597962744791616448487915667192875058592815636339507614499227407943494357843528056033773721711029552842160396617016884835556020495082061907517897139296921868726098793929456464992060745065258560960963184459787524683244617708108982997614880502648066019837184627185880652671440406751004823716138038578482286313872937436689907376336392198624082502390842170298696350711224912393805607280115907250438353352931044945179040370553648653866272291219097868230012644023837579478565817467758686729145484709030823195983554\\\\\\\",\\\\\\\"xr_cap\\\\\\\":[[\\\\\\\"demo-major\\\\\\\",\\\\\\\"164587753942899494168745746702534281563037669288218682692257391165325041732168189460545115812308404279240589114425046322356132181408031051286239643169009005958223435439799355211662444104531883082538176014292077920846413938760235906086381910034356130381286749206128094454452662283815044330730800323967902470312775790455241239653482745004223850680770052818976351902205471198454535294783397658320491100845383694178245356320509202610422971809318360852346231110471745351684915383461541209210464090117212587703482762934418809859227396852297417037033140072272676151762891624090259458948049903044932665550956351020903956472199708780575514718753305756346547634669337342447465198642113593266941556003489\\\\\\\"],[\\\\\\\"demo-gpa\\\\\\\",\\\\\\\"22199559154241071233540251324195337230927822968669546682924256492487853877953031345825385745900241025330375871523917849712725385790432951076987595680053019446054741259892564701293623250303595931063343966034351309995316956097733763166994791887902101149798874562034383975331980161354768409446422855147483195212437317537973845251280883872998417723398849872761881339298451486684674885318327796748378944659613162839511183514127487736387801234622230589841243519960874429783488747835807721882053729686382271314635805402653965411193898033208899024711454939860531264594452160431601266653407877024382554166965954564507888453238080543443825294612573362378277653648119231853727251371252426611250719223027\\\\\\\"],[\\\\\\\"demo-degree\\\\\\\",\\\\\\\"425307926357731961641889723351192532598285842402504657385351442966147456820187648192467747579412990962082780672922537000698541127067274541764366465881608778619655051450139613208362852093703153304455076974106861473420212168528190233224128135187035013850265971419193482519553936471029341985892219443902953021308950958867128132854325602761697845595230964616277064461362750199729352648568624273623621409353173348918863292813264771105478518129083486751236120470941869433608154015175461988708774026503367528484264960283828722023093081762732688330723751523175400425861380454412846687704806799430524033550455771282169951369159625112011956983708855437333914168956346464882619206522338259213757536326058\\\\\\\"],[\\\\\\\"demo-studentname\\\\\\\",\\\\\\\"332942112992078956065502211608387712655001083010169952511826075054945177324008673179434276989273295506738415570486847706494046829912089490672907344863578560956535931875873789276035124529730434622632506113551817581613699326755751216014910566217111708516008633400092766396982417384090165975121601372757060655383618934195784794468382484016906065941618773224768793098806073747798898613543519044035259337593748741589107633738885055731088913891966617458130135496565870795773171361810258169268160133602228280475389510872612504749862640093542170867364327914094068393807397625776548483684493102676731111623554447585743020640035792033063140954939015249185968692270629089072758373236129352580683143071761\\\\\\\"],[\\\\\\\"demo-collegename\\\\\\\",\\\\\\\"256956542286851333861178542347550843546602336608011961558790339355582543368619947132431033284018607829183717192553026370913923276337100278000711086078700912704406969815450902416202898668180355104154375118864951703873631679369560591960412167087463159579554031232611474483835459581596891709629200793913448526516843429369270281150318082896345684610971073438995144135178721242301138106737185350870630144213892199456597667151448810510989482504838867314779162444998243004059058257958923094769333676695275088360084008223593237541561581754838827142975493992967377714562756829715354497023402091089159902814924453530031297226196362145195501696869223672653009915485152284531305174191275718734671168638531\\\\\\\"],[\\\\\\\"master_secret\\\\\\\",\\\\\\\"411035279220097313141639496560361556200182820268236744181042170495644257271602560662636267278449740845231099678615487666867274088697078282727112089775108679200935406965394662679949604744630828792989232095978841363694220200918070829219562333021609323718741068752958915034422243090830005990644002315152710000100339840653484954546420674392862441143898339041785588558280237678400651047112646434338047479802903948283008613054301117081310752384053946023208896128041360508717835899081555400948972385606201372740711885971254389857009228358812537741320250162116765962040122767139702034734251663243075544887564157715654976094619015563754259692900247899890694680086596189292951372041405036180254469521378\\\\\\\"]]},\\\\\\\"nonce\\\\\\\":\\\\\\\"451547265861164114557369\\\\\\\"}\\\",\\\"msg_ref_id\\\":\\\"b060ca52-873e-4606-bf49-8ba83e4320a0\\\",\\\"msg_type\\\":\\\"CRED_OFFER\\\",\\\"schema_seq_no\\\":0,\\\"thread_id\\\":null,\\\"to_did\\\":\\\"Byyf6DiChBaukbgPssuFi1\\\",\\\"version\\\":\\\"0.1\\\"}]\"}"
}
```
