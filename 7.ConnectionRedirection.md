# Connection Redirection

- [Connection invite retrieval](#connection-invite-retrieval)
- [1. Deserialize connection](#1-deserialize-connection)    
- [2. Get invite details](#2-get-invite-details)    
- [Compare proprietary invite](#compare-proprietary-invite)
- [Proprietary connection redirection.](#proprietary-connection-redirection)
- [1. Deserialize connection](#1-deserialize-connection-1)
- [2. Create connection with new invite](#2-create-connection-with-new-invite)
- [3. Redirect connection](#3-redirect-connection)
- [Compare aries invites](#compare-aries-invites)
- [Aries invite redirection](#aries-invite-redirection)
- [1. Deserialize connection](#1-deserialize-connection-2)
- [2. Send connection reuse](#2-send-connection-reuse)

With adding more and more connections, its getting hard for user to remember which connections are already established. There is potential that some of the new connections user tries to establish already exists in list of connections (e.g. QR code was scanned multiple types). In this case we should not create new connection and try to reuse existing one.

> **NOTE:** library should be initialized before using connections API. See [initialization documentation](2.%20Initialization.md)

## Connection invite retrieval

To check does connection already exists, we need to retrieve invitation it was used during creation.

### 1. Deserialize connection

#### iOS
```objC
[appDelegate.sdkApi connectionDeserialize:serializedConnection
        completion:^(NSError *error, NSInteger connectionHandle) {
            // ...
        }];
```

#### Android
```java
int connectionHandle = ConnectionApi.connectionDeserialize(serializedConnection).get();
```

### 2. Get invite details

#### iOS
<!--TODO add obj-c sample-->

#### Android
```java
String connectionInvite = ConnectionApi.connectionInviteDetails(handle, abbreviated).get();
```
`abbreviated` parameter takes values `0` or `1`. For `0` it will return full names of invite fields, or shortened names for `1`.

## Compare proprietary invite

Proprietary invite will have `id` field in the invitation.
In this case for new invite and connection invite `senderDetail.DID` fields should be compared (`s.d` for abbreviated versions)

## Proprietary connection redirection.

In case both invite DIDs are equal, redirection process should  be performed:

### 1. Deserialize connection

#### iOS
```objC
[appDelegate.sdkApi connectionDeserialize:serializedConnection
        completion:^(NSError *error, NSInteger connectionHandle) {
            // ...
        }];
```

#### Android
```java
int existingConnectionHandle = ConnectionApi.connectionDeserialize(serializedConnection).get();
```

### 2. Create connection with new invite

#### iOS
```objC
[appDelegate.sdkApi connectionCreateWithInvite:invitationId
        inviteDetails:newInvite
        completion:^(NSError *error, NSInteger connectionHandle) {
            // ...
        }];
```

#### Android
```java
int newConnectionHandle = ConnectionApi.vcxCreateConnectionWithInvite(invitationId, newInvite).get();
```

### 3. Redirect connection

#### iOS
<!--TODO check new and existing connection param order-->
```objC
[appDelegate.sdkApi connectionCreateWithInvite:newConnectionHandle
        withConnectionHandle:existingConnectionHandle
        withCompletion:^(NSError *error) {
            // ...
        }];
```

#### Android
```java
int newConnectionHandle = ConnectionApi.vcxConnectionRedirect(newConnectionHandle, existingConnectionHandle).get();
```


## Compare aries invites

Aries invtes should contain `@id` and `@type` fields that are matching.

## Aries invite redirection

Depending on connection existence and availablity of `handshake_protocols` and `request~attach` fields in new invite, different actions should be taken.
<!-- TODO copy table from CM-2659 -->

### 1. Deserialize connection

#### iOS
```objC
[appDelegate.sdkApi connectionDeserialize:serializedConnection
        completion:^(NSError *error, NSInteger connectionHandle) {
            // ...
        }];
```

#### Android
```java
int existingConnectionHandle = ConnectionApi.connectionDeserialize(serializedConnection).get();
```

### 2. Send connection reuse

#### iOS
```objC
[appDelegate.sdkApi connectionSendReuse:existingConnectionHandle
        invite:newInvite
        withCompletion:^(NSError *error) {
            // ...
        }];
```

#### Android
```java
 ConnectionApi.connectionSendReuse(existingConnectionHandle, newInvite).get();
```
