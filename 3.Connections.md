# 3. Connections
To set up a connection between the Inviter (server) and the Responder (client) the process must complete these steps: <!--[Q1] Is this correct?-->

  1. Check type of invitation (`proprietary` and `aries` and `aries out-of-band` formats are supported)
  2. Depending on invite type call according methods
  3. Await connection status change

 Currently, Connect.Me can respond only to a connection invitation that has been generated by the Inviter. It can respond in one of two ways: 
 
 * Scanning a properly formatted QR code
 
 * Deep linking 

To accept a connection invitation and form a new connection, Connect.Me generates a new unique DID and associated keypair. The public key is then included in the response to the Inviter. 

This exchange results in both parties recording the other's public key, thereby forming a unique pairwise encryption channel. Connect.Me can form an unlimited number of connections in this way.


## Verifying invitation type

* Proprietary invitation must have `id` field in it 
* Aries invitation must have `@id` and `@type` fields.\
  For plain invitation it should end with `connections/1.0/invitation` string.\
  For out-of-band invitations it should end with `out-of-band/1.0/invitation` string.

## 1. Establishing a Connection via QR Code



### iOS
This code is in the `addNewConn` section of `mobile-starter-master/ios/CMeSdkObjc/CMeSdkObjc/ViewController.m`

<!--[Q2] For what purpose is this code provided? Are they supposed to study it? Edit it? Do you want to define any of the variables?-->


```objC
- (IBAction)addNewConn:(id)sender {
    AppDelegate *appDelegate = (AppDelegate*)[[UIApplication sharedApplication] delegate];

    NSUserDefaults *standardUserDefaults = [NSUserDefaults standardUserDefaults];

    NSString *connConfig = self.addConnConfig.text;

    NSError* error;
    NSMutableDictionary *configValues = [NSJSONSerialization JSONObjectWithData: [connConfig dataUsingEncoding: NSUTF8StringEncoding] options: NSJSONReadingMutableContainers error: &error];

    [appDelegate.sdkApi connectionCreateWithInvite: [configValues valueForKey: @"id"]
        inviteDetails: connConfig
        completion:^(NSError *error, NSInteger connectionHandle) {
            if (error != nil && error.code != 0)
            {
                // handle errors
                return;
            }

            // connectionConnect with connectionHandle
            [appDelegate.sdkApi connectionConnect: connectionHandle
                connectionType: @"{\"connection_type\":\"QR\",\"phone\":\"\"}"
                completion: ^(NSError *error, NSString *inviteDetails) {
                    if (error != nil && error.code != 0)
                    {
                        // handle errors
                        return;
                    }
                    [appDelegate.sdkApi connectionSerialize: connectionHandle
                        completion:^(NSError *error, NSString *state) {
                        if (error != nil && error.code != 0)
                        {
                            // handle errors
                            return;
                        }
                        // Store the serialized connection
                        if (standardUserDefaults) {
                            [standardUserDefaults setObject: state forKey: @"serializedConnection"];
                            [standardUserDefaults synchronize];
                        }
                    }];
            }];
    }];
}
```


### Android

You could see `Connections#create()` for connection creation samples.

####  Creating connection

1. For proprietary and aries invitation:

    ```java
    int connectionHandle = ConnectionApi.vcxCreateConnectionWithInvite(invitationId, invitationDetails).get();
    ```

    For out-of-band invitation:
    ```java
    int connectionHandle = ConnectionApi.vcxCreateConnectionWithOutofbandInvite(invitationId, invitationDetails).get();
    ```

    Successful execution will return connection handle that will be used in latter operations.

2. To establish connection, call:
    ```java
    ConnectionApi.vcxConnectionConnect(connectionHandle, connType).get();
    ```

3. After successful connection establishing connection should be serialized into JSON string:
    ```java
    String serializedConnection = ConnectionApi.connectionSerialize(handle).get();
    ```
    `serialzedConnection` should be stored (e.g. in database) for later operations with this connection.

4. Await message status change. Call following code in loop until returned state is not equal `4` (`Accepted`):
    ```java
    Integer state = ConnectionApi.vcxConnectionUpdateState(handle).get();
    ```

## 2. Establishing a Connection via Deep Link

The process of accepting connection invitations via deep link is similar to scanning a QR code: the only difference is the way that the full JSON object of the connection invitation is retrieved. With a QR code the whole object is included in the QR data, whereas with deep links the flow has the additional step of downloading the whole object from a third-party resource (based on a short link received in SMS, for example). 

<!--[Q4] How do they set up a deep link? Do we need instructions here or code examples?-->

## 3. Example of a Connection Invitation Object

<!--[Q5] Is this an example of a deep link?-->

<!--[Q6] What do the attributes mean? l = link, n = name, what else?-->

### Proprietary invitation 

```json 
{
    "id": "NjAzNTY",
    "s": {
        "d": "JFatV7UCKPsSTqDBcuUBiN",
        "dp": {
            "d": "3x2MKKabjGxvMQwLBk5yWn",
            "k": "2cDPDb4bdSW1UFtKUV2y2b1TfG4T36T3miBrLRsFnwLx",
            "s": "YFZQahGN2o08VtMKVTOJIpyJnoQFC2snMre/xabgGNOlUuMNAjtFCwvlVGbPdQ92Kh4iYiHadkjdv81y5OeJCA=="
        },
        "l": "https://s22.postimg.cc/wu8r1enjl/evernym.png",
        "n": "Evernym Staging",
        "v": "AQMSbbDhsRJbgpLh84pFTBJBArh6qQ2vBiBfJPzeEMZA"
    },
    "sa": {
        "d": "j9PTs554BYkgMggRhiJip",
        "e": "eas.pstg.evernym.com:80/agency/msg",
        "v": "PyGuGpa49Fii2CLiRG6Wff7NddPg3aAuyi4BXzerWwj"
    },
    "sc": "MS-101",
    "sm": "message created",
    "t": "there",
    "threadId": null,
    "version": "1.0"
}
```
To show information about invitation you will need to extract following fields:
- `invite["s"]["n"]` - Name of the inviter
- `invite["s"]["l"]` - URL of the inviter logo (optional)

### Aries invitation

```json
{
    "label": "Acme",
    "serviceEndpoint": "http://vas.evernym.com:80/agency/msg",
    "recipientKeys": [
        "9NR9NYh5z5HHu6nLHnQWXczUqRwrdoL4KBUWvo2fE6vj"
    ],
    "routingKeys": [
        "9NR9NYh5z5HHu6nLHnQWXczUqRwrdoL4KBUWvo2fE6vj",
        "3mo3P6XzDzBvuktCgDQarACzzeV7zxrSExnicpuH7t83"
    ],
    "profileUrl": "https://s3.us-east-2.amazonaws.com/public-demo-artifacts/demo-icons/cbACME.png",
    "@type": "did:sov:BzCbsNYhMrjHiqZDTUASHg;spec/connections/1.0/invitation",
    "@id": "467f6449-7d1f-4a9f-ada7-09d6444af083"
}
```
To show information about invitation you need to extract following fields:
- `invite["label"]` - Name of the inviter
- `invite["profileUrl"]` - URL with inviter logo (optional)