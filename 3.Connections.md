# 3. Connections
To set up a connection between the Inviter (server) and the Responder (client) the process must complete these steps: <!--[Q1] Is this correct?-->

  - [1. Establishing a connection via QR code](#1-establishing-connection-via-qr-code)
  - [2. Establishing a connection via deep link](#2-establishing-a-connection-via-deep-link)
  - [3. Example of a Connection Invitation Object](#3-example-of-a-connection-invitation-object)


 Currently, Connect.Me can respond only to a connection invitation that has been generated by the Inviter. It can respond in one of two ways: 
 
 * Scanning a properly formatted QR code
 
 * Deep linking 

To accept a connection invitation and form a new connection, Connect.Me generates a new unique DID and associated keypair. The public key is then included in the response to the Inviter. 

This exchange results in both parties recording the other's public key, thereby forming a unique pairwise encryption channel. Connect.Me can form an unlimited number of connections in this way.


## 1. Establishing a Connection via QR Code



### iOS
This code is in the `addNewConn` section of `mobile-starter-master/ios/CMeSdkObjc/CMeSdkObjc/ViewController.m`

<!--[Q2] For what purpose is this code provided? Are they supposed to study it? Edit it? Do you want to define any of the variables?-->


```objC
- (IBAction)addNewConn:(id)sender {
    AppDelegate *appDelegate = (AppDelegate*)[[UIApplication sharedApplication] delegate];

    NSUserDefaults *standardUserDefaults = [NSUserDefaults standardUserDefaults];

    NSString *connConfig = self.addConnConfig.text;

    NSError* error;
    NSMutableDictionary *configValues = [NSJSONSerialization JSONObjectWithData: [connConfig dataUsingEncoding: NSUTF8StringEncoding] options: NSJSONReadingMutableContainers error: &error];

    [appDelegate.sdkApi connectionCreateWithInvite: [configValues valueForKey: @"id"]
        inviteDetails: connConfig
        completion:^(NSError *error, NSInteger connectionHandle) {
            if (error != nil && error.code != 0)
            {
                // handle errors
                return;
            }

            // connectionConnect with connectionHandle
            [appDelegate.sdkApi connectionConnect: connectionHandle
                connectionType: @"{\"connection_type\":\"QR\",\"phone\":\"\"}"
                completion: ^(NSError *error, NSString *inviteDetails) {
                    if (error != nil && error.code != 0)
                    {
                        // handle errors
                        return;
                    }
                    [appDelegate.sdkApi connectionSerialize: connectionHandle
                        completion:^(NSError *error, NSString *state) {
                        if (error != nil && error.code != 0)
                        {
                            // handle errors
                            return;
                        }
                        // Store the serialized connection
                        if (standardUserDefaults) {
                            [standardUserDefaults setObject: state forKey: @"serializedConnection"];
                            [standardUserDefaults synchronize];
                        }
                    }];
            }];
    }];
}
```


### Android

This code is in the `addConnectionOnClick` section of `mobile-starter-master/android/CMeSdkJava/app/src/main/java/me/connect/sdk/java/MainActivity.java`

<!--[Q3] For what purpose is this code provided? Are they supposed to study it? Edit it? Do you want to define any of the variables?-->


```java
    public void addConnectionOnClick(View v) {
        EditText editText   = (EditText)findViewById(R.id.editText2);
        String invitationDetails = editText.getText().toString();
        Log.d(TAG, "connection invitation is set to: " + invitationDetails);

        try {
            JSONObject json = new JSONObject(invitationDetails);
            sdkApi.createConnectionWithInvite(json.getString("id"), invitationDetails, new CompletableFuturePromise<>(connectionHandle -> {
                if(connectionHandle != -1) {
                    sdkApi.vcxAcceptInvitation(connectionHandle, "{\"connection_type\":\"QR\",\"phone\":\"\"}", new CompletableFuturePromise<>(inviteDetails -> {
                        if(invitationDetails != null) {
                            sdkApi.getSerializedConnection(connectionHandle, new CompletableFuturePromise<>(state -> {
                                // handle serialized connection state
                            }, (t) -> {
                                // handle errors
                                return null;
                            }));
                        }
                    }, (t) -> {
                        // handle successful result
                        return null;
                    }));
                }
            }, (t) -> {
                // handle errors
                return -1;
            }));
        } catch (JSONException e) {
            // handle errors
        }
    }
```

## 2. Establishing a Connection via Deep Link

The process of accepting connection invitations via deep link is similar to scanning a QR code: the only difference is the way that the full JSON object of the connection invitation is retrieved. With a QR code the whole object is included in the QR data, whereas with deep links the flow has the additional step of downloading the whole object from a third-party resource (based on a short link received in SMS, for example). 

<!--[Q4] How do they set up a deep link? Do we need instructions here or code examples?-->

## 3. Example of a Connection Invitation Object

<!--[Q5] Is this an example of a deep link?-->

<!--[Q6] What do the attributes mean? l = link, n = name, what else?-->

```json 
{
    "id": "NjAzNTY",
    "s": {
        "d": "JFatV7UCKPsSTqDBcuUBiN",
        "dp": {
            "d": "3x2MKKabjGxvMQwLBk5yWn",
            "k": "2cDPDb4bdSW1UFtKUV2y2b1TfG4T36T3miBrLRsFnwLx",
            "s": "YFZQahGN2o08VtMKVTOJIpyJnoQFC2snMre/xabgGNOlUuMNAjtFCwvlVGbPdQ92Kh4iYiHadkjdv81y5OeJCA=="
        },
        "l": "https://s22.postimg.cc/wu8r1enjl/evernym.png",
        "n": "Evernym Staging",
        "v": "AQMSbbDhsRJbgpLh84pFTBJBArh6qQ2vBiBfJPzeEMZA"
    },
    "sa": {
        "d": "j9PTs554BYkgMggRhiJip",
        "e": "eas.pstg.evernym.com:80/agency/msg",
        "v": "PyGuGpa49Fii2CLiRG6Wff7NddPg3aAuyi4BXzerWwj"
    },
    "sc": "MS-101",
    "sm": "message created",
    "t": "there",
    "threadId": null,
    "version": "1.0"
}

```

