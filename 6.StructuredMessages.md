# Structured Messages (Questions)

Secured, encrypted communication between paired clients is established by following these steps:

- [Prerequisites:](#prerequisites)
- [1. Message received](#1-message-received)
- [1. Retrieve pending messages](#1-retrieve-pending-messages)
- [2. Parse message](#2-parse-message)
- [1. Deserialize connection](#1-deserialize-connection)
- [2. Sign answer](#2-sign-answer)
- [3. Prepare answer JSON](#3-prepare-answer-json)
- [4. Send message](#4-send-message)
- [5. Update message](#5-update-message)

--- 

## Prerequisites: 

In order to provide your users best experience while using mobile app, we strongly suggests to implement and support push notifications. The steps for implementation of push notifications can be different for iOS and Android platform or you can use some of the solutions which offers support for both of them, like Google's [Firebase Cloud Messaging](https://firebase.google.com/docs/cloud-messaging). You will notice in our example code that we used the same. 

--- 

## 1. Message received
In this step, we assume you have installed push notification service, so user does not need to manually download messages. Push notification message usually contains similar attributes like icon, vibrate, etc. but we are mostly interested in message body. 
Attributes in body we are looking for are: 

- **@type**: type for push notification message. It can be: *cred*, *credOffer*, *proofReq* and *Question*. For structured messages, type of the push notification will be **Question**.  
- **@uid**: identifier for specific message we are receiving
- **@forDID**: identifier for connection fom which notification was sent

When push notification message is received, we will need to call **downloadMessages** in VCX library, with providing uid and forDid details from notification body.  

All work regarding parsing and downloading messages we can organize in single class, we will call it `IndyMessages.<ext>` (extension depends on your preferred platform, .swift / objc .h - .m, .java etc.)


## 1. Retrieve pending messages
See [messages documentation](8.%20Messages.md) for message retrieval information. Pending messages with question type should be retrieved.

## 2. Parse message

From message payload following fields should be retrieved:

* `@id` - ID of the message
* `question_text` - Question to show to user
* `question_details` - Additional details for question
* `valid_responses` - Array of possible answers for structured message. Each entry has following fields:
	* `text` - Readable representation of valid response.
	* `nonce` - String that should be sent for seleceted response.

### Android

See `me.connect.sdk.java.StructuredMessages#extract` for reference

To answer message

## 1. Deserialize connection

### Android
```java
int connectionHandle = ConnectionApi.connectionDeserialize(serializedConnection).get();
```

## 2. Sign answer

To perform sign, answer should be ecnoded to Base-64.

### Android
```java
byte[] encodedAnswer = Base64.encode(answer.getBytes(), Base64.NO_WRAP);
String signature = ConnectionApi.connectionSignData(conHandle, encodedAnswer, encodedAnswer.length).get();
```

## 3. Prepare answer JSON 

Two JSON objects should be prepared:
* message
	```json
	{
		"@type": "did:sov:BzCbsNYhMrjHiqZDTUASHg;spec\/committedanswer\/1.0\/answer",
		"response.@sig": {
			"signature": "BAUG", // Base64 encoded answer
			"sig_data": "ABCD", // Signed data
			"timestamp": 1598368957 // Time when response was prepared in Unix time
		}
	}
	```

* message options
	```json
	{
		"msg_type": "Answer", // constant value
		"msg_title": "Peer sent answer", // constant value
		"ref_msg_id": "abcdEFG123" // ID of message
	}
	```

### Android
See `me.connect.sdk.java.message.MessageUtils#prepareAnswer`

## 4. Send message

### Android
```java 
ConnectionApi.connectionSendMessage(connectionHandle, message, messageOptions).get();
```

### 5. Update message
See [messages documentation](8.%20Messages.md) for message retrieval information. Pending messages with structured message type should be retrieved.